<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Signaling Flow - Manual Render</title>
        <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 50px;
            background-color: #f7f8fa;
            color: #24292e;
        }

        #diagram-container {
            position: relative;
            display: flex;
            gap: 100px; /* Increased gap between columns */
            padding: 30px;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px; /* Increased gap between boxes */
            padding: 25px;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            min-width: 240px;
        }

        .column h2 {
            margin: 0 0 25px 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e4e8;
            font-size: 20px; /* Increased font size */
            font-weight: 600;
            color: #0366d6;
            width: 100%;
            text-align: center;
        }

        .box {
            border: 1px solid #d1d5da;
            background-color: #f6f8fa;
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            font-size: 16px; /* Increased font size */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        #c1 {
            position: absolute;
            bottom: -100px; /* Adjusted position */
            left: 50%;
            transform: translateX(-50%);
            background-color: #e6ffed;
            border-color: #28a745;
            color: #155724;
            width: 180px;
            font-weight: 500;
        }

        #arrow-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
        }
        
        .arrow-label {
            font-size: 30px; /* Increased font size */
            fill: #e70d0d;
            font-style: italic;
            text-anchor: middle;
            dominant-baseline: middle;
            background-color: #f7f8fa;
            padding: 2px;
        }
    </style>
</head>
<body>

<div id="diagram-container">
    <!-- SVG Canvas for Arrows -->
    <svg id="arrow-canvas"></svg>

    <!-- Column 1: Caller -->
    <div class="column" id="caller-column">
        <h2>Caller (User A)</h2>
        <div class="box" id="a1">点击呼叫</div>
        <div class="box" id="a2">获取本地音频流</div>
        <div class="box" id="a3">发送 call-request</div>
        <div class="box" id="a4">收到 call-response(accept)</div>
        <div class="box" id="a5">创建 Offer</div>
        <div class="box" id="a6">发送 Offer</div>
        <div class="box" id="a7">收到 Answer</div>
        <div class="box" id="a8">设置远端描述</div>
    </div>

    <!-- Column 2: Signaling Server -->
    <div class="column" id="server-column">
        <h2>Signaling Server</h2>
        <div class="box" id="s1">检查 User B 是否在线</div>
        <div class="box" id="s2">转发 call-request</div>
        <div class="box" id="s3">转发 call-response</div>
        <div class="box" id="s4">转发 Offer</div>
        <div class="box" id="s5">转发 Answer</div>
        <div class="box" id="s6">双向转发 ICE Candidates</div>
    </div>

    <!-- Column 3: Callee -->
    <div class="column" id="callee-column">
        <h2>Callee (User B)</h2>
        <div class="box" id="b1">收到 call-request</div>
        <div class="box" id="b2">用户选择接受</div>
        <div class="box" id="b3">发送 call-response(accept)</div>
        <div class="box" id="b4">收到 Offer</div>
        <div class="box" id="b5">设置远端描述</div>
        <div class="box" id="b6">创建 Answer</div>
        <div class="box" id="b7">发送 Answer</div>
    </div>
    
    <div class="box" id="c1">通话中</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const svg = document.getElementById('arrow-canvas');
        const container = document.getElementById('diagram-container');

        // Define arrow markers
        function createMarker(id, color) {
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', id);
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '7');
            marker.setAttribute('refX', '8');
            marker.setAttribute('refY', '3.5');
            marker.setAttribute('orient', 'auto');
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
            polygon.setAttribute('fill', color);
            marker.appendChild(polygon);
            return marker;
        }

        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        defs.appendChild(createMarker('arrowhead-default', '#586069'));
        defs.appendChild(createMarker('arrowhead-red', '#d73a49'));
        svg.appendChild(defs);

        function getElementCoords(elementId) {
            const elem = document.getElementById(elementId);
            const rect = elem.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            return {
                x: rect.left - containerRect.left,
                y: rect.top - containerRect.top,
                width: rect.width,
                height: rect.height
            };
        }

        function drawArrow(startId, endId, options = {}) {
            const startCoords = getElementCoords(startId);
            const endCoords = getElementCoords(endId);
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            
            let x1, y1, x2, y2;

            if (startCoords.x < endCoords.x) { // Going right
                x1 = startCoords.x + startCoords.width;
                x2 = endCoords.x;
            } else { // Going left
                x1 = startCoords.x;
                x2 = endCoords.x + endCoords.width;
            }
            
            y1 = startCoords.y + startCoords.height / 2;
            y2 = endCoords.y + endCoords.height / 2;

            // Vertical arrows
            if (Math.abs(startCoords.x - endCoords.x) < 50) { 
                 x1 = startCoords.x + startCoords.width / 2;
                 x2 = endCoords.x + endCoords.width / 2;
                 y1 = startCoords.y + startCoords.height;
                 y2 = endCoords.y;
            }

            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke-width', '2');

            const isLabeled = !!options.label;
            const arrowColor = isLabeled ? '#d73a49' : '#586069';
            const markerId = isLabeled ? 'url(#arrowhead-red)' : 'url(#arrowhead-default)';

            line.setAttribute('stroke', arrowColor);
            line.setAttribute('marker-end', markerId);

            if (options.dashed) {
                line.setAttribute('stroke-dasharray', '5,5');
            }
            if (options.bidirectional) {
                line.setAttribute('marker-start', markerId);
            }

            svg.appendChild(line);

            if (isLabeled) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', (x1 + x2) / 2);
                text.setAttribute('y', (y1 + y2) / 2 - 8);
                text.classList.add('arrow-label');
                if (isLabeled) {
                    text.style.fill = arrowColor;
                }
                text.textContent = options.label;
                svg.appendChild(text);
            }
        }

        const connections = [
            { from: 'a1', to: 'a2' },
            { from: 'a2', to: 'a3' },
            { from: 'a3', to: 's1' },
            { from: 's1', to: 's2', label: '在线' },
            { from: 's2', to: 'b1' },
            { from: 'b1', to: 'b2' },
            { from: 'b2', to: 'b3' },
            { from: 'b3', to: 's3' },
            { from: 's3', to: 'a4' },
            { from: 'a4', to: 'a5' },
            { from: 'a5', to: 'a6' },
            { from: 'a6', to: 's4' },
            { from: 's4', to: 'b4' },
            { from: 'b4', to: 'b5' },
            { from: 'b5', to: 'b6' },
            { from: 'b6', to: 'b7' },
            { from: 'b7', to: 's5' },
            { from: 's5', to: 'a7' },
            { from: 'a7', to: 'a8' },
            { from: 'a5', to: 's6', label: 'onicecandidate' },
            { from: 'b6', to: 's6', label: 'onicecandidate' },
            { from: 's6', to: 'a8', label: '转发' },
            { from: 's6', to: 'b5', label: '转发' },
            { from: 'a8', to: 'b5', bidirectional: true },
            { from: 'a8', to: 'c1', label: '连接建立', dashed: true },
            { from: 'b5', to: 'c1', label: '连接建立', dashed: true },
        ];

        connections.forEach(conn => drawArrow(conn.from, conn.to, conn));
    });
</script>

</body>
</html>
