# 视频通话模块测试指南

## 测试环境准备

### 1. 开发服务器启动
```bash
cd d:\Desktop\ArcHat\Client-site
npm run dev
```
服务器地址: http://localhost:3002

### 2. 浏览器要求
- 支持WebRTC的现代浏览器（Chrome、Firefox、Safari、Edge）
- 需要摄像头和麦克风权限
- 建议使用两个不同的浏览器窗口或设备进行测试

## 功能测试清单

### ✅ 基础组件测试

#### 1. 视频通话Store (videoCall.js)
- [x] 独立状态管理
- [x] 与语音通话互斥检测
- [x] WebSocket连接状态检查
- [x] 视频通话生命周期管理

#### 2. 视频WebRTC管理器 (videoWebrtc.js)
- [x] 独立WebRTC连接管理
- [x] 视频通话专用信令处理
- [x] 摄像头切换功能
- [x] 错误处理和资源清理

#### 3. 全局视频通话气泡 (VideoCallBubble.vue)
- [x] 大视频显示区域
- [x] 本地视频预览
- [x] 控制按钮：静音、视频开关、摄像头切换、最小化、挂断
- [x] 高性能拖拽实现

#### 4. 视频通话来电通知 (IncomingVideoCallNotification.vue)
- [x] 自定义来电通知界面
- [x] 接听/拒绝逻辑

#### 5. 通话选项弹窗 (CallOptionsPopup.vue)
- [x] 语音通话和视频通话选项
- [x] 事件发送机制

### ✅ 系统集成测试

#### 1. App.vue集成
- [x] 视频通话管理器初始化
- [x] 视频通话组件全局注册
- [x] 与语音通话并行运行

#### 2. 信令路由系统 (user.js)
- [x] 基于信令类型的智能路由
- [x] 视频通话信令独立处理
- [x] 调试日志完整

#### 3. Chat.vue集成
- [x] startVideoCall函数实现
- [x] 视频通话store集成
- [x] 错误处理和用户反馈

## 端到端测试流程

### 测试场景1：正常视频通话流程
1. **发起通话**
   - 登录两个不同的用户账号
   - 在聊天界面点击通话按钮
   - 选择"视频通话"选项
   - 验证通话邀请发送成功

2. **接收通话**
   - 验证接收方收到来电通知
   - 点击"接听"按钮
   - 验证视频通话建立成功

3. **通话中功能**
   - 测试静音/取消静音
   - 测试视频开关
   - 测试摄像头切换（前后摄像头）
   - 测试气泡拖拽功能
   - 测试最小化/展开功能

4. **结束通话**
   - 点击挂断按钮
   - 验证通话正确结束
   - 验证资源正确清理

### 测试场景2：互斥机制测试
1. **语音通话进行中发起视频通话**
   - 先发起语音通话
   - 尝试发起视频通话
   - 验证提示"当前有通话正在进行"

2. **视频通话进行中发起语音通话**
   - 先发起视频通话
   - 尝试发起语音通话
   - 验证提示"当前有通话正在进行"

### 测试场景3：异常情况处理
1. **网络断开测试**
   - 断开WebSocket连接
   - 尝试发起视频通话
   - 验证提示"网络连接已断开"

2. **拒绝通话测试**
   - 发起视频通话
   - 接收方点击"拒绝"
   - 验证发起方收到拒绝提示

3. **超时测试**
   - 发起视频通话
   - 不进行任何操作
   - 验证自动超时处理

## 调试信息检查

### 浏览器控制台日志
- 视频通话管理器初始化日志
- 信令发送和接收日志
- WebRTC连接状态日志
- 摄像头切换日志
- 错误处理日志

### 关键日志标识
- `🎥` - 视频通话相关日志
- `✅` - 成功操作日志
- `❌` - 错误日志
- `📞` - 语音通话日志（用于区分）

## 性能测试

### 1. 内存使用
- 监控通话过程中的内存使用
- 验证通话结束后资源正确释放

### 2. CPU使用
- 监控视频编解码CPU占用
- 验证拖拽操作的性能

### 3. 网络使用
- 监控WebRTC数据传输
- 验证信令传输效率

## 已知问题和限制

### 1. 浏览器兼容性
- 某些旧版本浏览器可能不支持最新WebRTC特性
- 移动端浏览器的摄像头切换可能有限制

### 2. 网络环境
- NAT穿透可能需要TURN服务器支持
- 弱网环境下可能影响通话质量

### 3. 设备权限
- 需要用户授权摄像头和麦克风权限
- 某些企业网络可能阻止WebRTC连接

## 测试完成标准

- [ ] 所有基础组件功能正常
- [ ] 端到端通话流程完整
- [ ] 互斥机制工作正确
- [ ] 异常情况处理得当
- [ ] 性能表现良好
- [ ] 用户体验流畅

## 后续优化方向

1. **UI/UX优化**
   - 通话质量指示器
   - 更丰富的通话控制选项
   - 自适应布局优化

2. **功能扩展**
   - 屏幕共享功能
   - 多人视频通话
   - 通话录制功能

3. **性能优化**
   - 视频编码参数优化
   - 网络自适应调整
   - 电池使用优化
