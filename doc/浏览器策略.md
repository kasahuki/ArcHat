# 浏览器策略处理方案

## 问题描述

### 核心问题
浏览器在后台时WebSocket连接会自动断开，导致用户切换标签页、最小化窗口或长时间不操作时失去实时通信能力。

### 问题原因
1. **浏览器节能机制**：现代浏览器为了节省资源，会在页面进入后台时降低JavaScript定时器的执行频率
2. **心跳包延迟**：原本15秒间隔的心跳包在后台可能变成几分钟才发送一次
3. **服务器超时**：服务器端没有及时收到心跳包，认为客户端已断开连接，主动关闭WebSocket
4. **Page Visibility API影响**：浏览器的页面可见性变化会影响JavaScript执行优先级

### 影响范围
- 聊天消息无法实时接收
- 通话邀请可能丢失
- 用户状态同步异常
- 需要手动刷新页面才能恢复连接

## 解决方案

### 技术方案：双重心跳策略 + 页面可见性监听

#### 核心思路
通过监听页面可见性变化，在前台和后台使用不同的心跳策略：
- **前台模式**：正常心跳间隔（15秒）
- **后台模式**：高频心跳间隔（8秒）

#### 实现机制
1. **页面可见性监听**
   - 监听 `visibilitychange` 事件
   - 监听 `focus`/`blur` 事件作为补充
   - 实时跟踪页面前台/后台状态

2. **智能心跳切换**
   - 页面进入后台 → 启动高频心跳保持连接
   - 页面回到前台 → 恢复正常心跳，检查连接状态

3. **自动重连机制**
   - 页面恢复可见时自动检测连接状态
   - 发现断开时立即尝试重连
   - 避免用户感知到连接中断

### 技术特点
- ✅ **零侵入性**：不影响现有业务逻辑
- ✅ **自动化**：无需用户手动干预
- ✅ **资源优化**：前台后台差异化心跳频率
- ✅ **兼容性好**：使用标准Web API
- ✅ **可插拔**：使用#region标记，便于管理

## 涉及文件

### 主要修改文件

#### 1. `src/api/chat.js` - WebSocket连接管理类
**修改内容**：
- 添加页面可见性相关属性
- 实现双重心跳策略
- 添加页面可见性监听器
- 完善资源清理机制

**关键方法**：
```javascript
// 页面可见性监听
addVisibilityListeners()
removeVisibilityListeners()

// 后台心跳管理
startBackgroundHeartbeat()
stopBackgroundHeartbeat()
```

### 代码结构

#### 构造函数新增属性
```javascript
//#region 防止浏览器后台断开WebSocket连接
// 页面可见性相关 - 防止后台断开
this.isPageVisible = !document.hidden;
this.backgroundHeartbeatInterval = null;
this.visibilityChangeHandler = null;
//#endregion
```

#### 初始化调用
```javascript
//#region 防止浏览器后台断开WebSocket连接 - 初始化
this.addVisibilityListeners();
//#endregion
```

#### 清理调用
```javascript
//#region 防止浏览器后台断开WebSocket连接 - 清理
this.removeVisibilityListeners(); // 清理页面可见性监听器
//#endregion
```

## 实现细节

### 页面可见性监听实现
```javascript
addVisibilityListeners() {
  if (typeof document === 'undefined') return;
  
  this.visibilityChangeHandler = () => {
    this.isPageVisible = !document.hidden;
    
    if (this.isPageVisible) {
      console.log('页面变为可见，恢复正常心跳');
      // 页面变为可见时，停止后台心跳，恢复正常心跳
      this.stopBackgroundHeartbeat();
      if (this.connectionStatus === 'connected') {
        this.startHeartbeat();
      }
      // 检查连接状态，如果断开则重连
      if (!this.isConnected() && !this.isLoggedOut) {
        console.log('页面恢复可见时发现连接断开，尝试重连');
        this.manualReconnect();
      }
    } else {
      console.log('页面变为后台，启动后台心跳保持连接');
      // 页面变为后台时，使用更频繁的心跳保持连接
      this.startBackgroundHeartbeat();
    }
  };
  
  document.addEventListener('visibilitychange', this.visibilityChangeHandler);
  
  // 监听页面焦点变化作为补充
  window.addEventListener('focus', () => {
    if (!this.isPageVisible) {
      this.isPageVisible = true;
      this.visibilityChangeHandler();
    }
  });
  
  window.addEventListener('blur', () => {
    // blur事件可能比visibilitychange更早触发，这里做一个延迟检查
    setTimeout(() => {
      if (document.hidden && this.isPageVisible) {
        this.isPageVisible = false;
        this.visibilityChangeHandler();
      }
    }, 100);
  });
}
```

### 后台心跳实现
```javascript
startBackgroundHeartbeat() {
  this.stopBackgroundHeartbeat();
  this.stopHeartbeat(); // 停止正常心跳
  
  console.log('启动后台心跳保持连接');
  this.backgroundHeartbeatInterval = setInterval(() => {
    if (this.isLoggedOut || this.connectionStatus !== 'connected') {
      this.stopBackgroundHeartbeat();
      return;
    }
    
    // 后台时使用更短的心跳间隔
    console.log('发送后台心跳包');
    this.send({ type: 2 });
  }, 8000); // 8秒间隔，比正常心跳更频繁
}
```

## 工作流程

### 正常流程
```
用户正常使用页面
    ↓
WebSocket正常心跳 (15秒间隔)
    ↓
保持连接稳定
```

### 后台处理流程
```
用户切换标签页/最小化窗口
    ↓
页面变为后台 (document.hidden = true)
    ↓
触发 visibilitychange 事件
    ↓
停止正常心跳，启动后台心跳 (8秒间隔)
    ↓
保持WebSocket连接活跃
    ↓
用户回到页面
    ↓
页面变为前台 (document.hidden = false)
    ↓
停止后台心跳，恢复正常心跳
    ↓
检查连接状态，必要时重连
```

## 配置参数

### 可调整参数
- **正常心跳间隔**：15秒 (`startHeartbeat()` 方法中)
- **后台心跳间隔**：8秒 (`startBackgroundHeartbeat()` 方法中)
- **心跳超时时间**：2分钟 (`startHeartbeat()` 方法中)
- **页面状态检查延迟**：100毫秒 (blur事件处理中)

### 参数调优建议
- 如果服务器超时时间较短，可以减少后台心跳间隔
- 如果网络环境较差，可以增加心跳超时时间
- 根据实际使用情况调整检查延迟时间

## 测试验证

### 测试场景
1. **标签页切换测试**
   - 打开应用建立WebSocket连接
   - 切换到其他标签页等待1-2分钟
   - 切换回应用标签页
   - 验证连接是否正常，消息是否能正常收发

2. **窗口最小化测试**
   - 最小化浏览器窗口
   - 等待较长时间（5-10分钟）
   - 恢复窗口
   - 验证连接状态

3. **长时间后台测试**
   - 页面保持后台状态超过30分钟
   - 观察控制台日志中的后台心跳记录
   - 验证连接持续性

### 验证方法
- 观察浏览器控制台中的心跳日志
- 检查WebSocket连接状态
- 测试实时消息收发功能
- 验证通话邀请等实时功能

## 故障排除

### 常见问题
1. **后台心跳未启动**
   - 检查页面可见性API支持情况
   - 确认事件监听器正确绑定

2. **连接仍然断开**
   - 调整后台心跳间隔（减少到5-6秒）
   - 检查服务器端超时配置

3. **资源占用过高**
   - 适当增加后台心跳间隔
   - 优化心跳包大小

### 调试方法
- 启用详细的控制台日志
- 监控WebSocket连接状态变化
- 使用浏览器开发者工具的Network面板观察心跳包

## 兼容性

### 浏览器支持
- Chrome 33+
- Firefox 25+
- Safari 7+
- Edge 12+
- 移动端浏览器基本支持

### API依赖
- Page Visibility API (`document.hidden`, `visibilitychange`)
- WebSocket API
- 标准DOM事件 (`focus`, `blur`)

## 总结

通过实现双重心跳策略和页面可见性监听，成功解决了浏览器后台时WebSocket连接断开的问题。该方案具有零侵入性、自动化程度高、资源消耗合理等优点，能够显著提升用户体验，确保实时通信功能的稳定性。

该解决方案已通过#region标记进行模块化管理，便于后续维护和功能开关控制。
